<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turnos ‚Äì Sucursal La Tablada</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { .no-print{display:none} body{font-size:11px} .card{break-inside:avoid} }
    .badge{display:inline-flex;align-items:center;padding:.1rem .4rem;border-radius:9999px;font-size:.75rem;font-weight:500}
    .b-crovara{background:#dbeafe;color:#1e40af}.b-canning{background:#fef3c7;color:#92400e}
    .b-libre{background:#d1fae5;color:#065f46}.b-red{background:#fae8ff;color:#86198f}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="no-print sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-xl font-semibold">üìÖ Turnos ‚Äì Sucursal La Tablada</h1>
      <div class="flex flex-wrap gap-2">
        <select id="empleadoSelect" class="px-3 py-2 rounded-md border">
          <option value="Mat√≠as">Mat√≠as</option>
          <option value="Iv√°n">Iv√°n</option>
          <option value="Lautaro">Lautaro</option>
        </select>
        <button id="btnReload" class="px-3 py-2 rounded-md bg-slate-900 text-white">Recargar</button>
      </div>
    </div>
    <div id="appStatus" class="no-print max-w-5xl mx-auto px-4 mb-2 text-sm"></div>
  </header>

  <main class="max-w-5xl mx-auto p-4 flex flex-col gap-6">
    <section class="card p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <h2 class="text-lg font-semibold mb-3">Calendario (eventos del seleccionado)</h2>
      <div id="calendar" class="space-y-6"></div>
    </section>

    <section class="card p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <h2 class="text-lg font-semibold mb-3">Consultas r√°pidas</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <button class="qbtn px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200" data-q="libre">Pr√≥ximo s√°bado libre</button>
        <button class="qbtn px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200" data-q="canning">Pr√≥ximo s√°bado Canning</button>
        <button class="qbtn px-4 py-3 rounded-xl bg-slate-100 hover:bg-slate-200" data-q="reduccion">Pr√≥xima jornada reducida</button>
      </div>
      <div id="quickResult" class="mt-3 text-sm text-slate-700"></div>
    </section>

    <section class="card p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
      <h2 class="text-lg font-semibold mb-2">Intercambio de d√≠a</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="swapDate" type="date" class="w-full px-3 py-2 rounded-md border" />
        <select id="swapRequester" class="w-full px-3 py-2 rounded-md border">
          <option>Mat√≠as</option><option>Iv√°n</option><option>Lautaro</option>
        </select>
        <button id="btnCheckDay" class="w-full px-3 py-2 rounded-md bg-slate-900 text-white">Ver asignados</button>
      </div>
      <div id="swapInfo" class="mt-3 text-sm"></div>
      <div id="swapCTA" class="mt-2 text-sm"></div>
    </section>
  </main>

  <script>
    // ===== Debug visible en pantalla =====
    const statusBox = document.getElementById('appStatus');
    const say = (msg, ok=false) => {
      if (!statusBox) return;
      statusBox.innerHTML = `<div class="${
        ok ? 'text-emerald-700 bg-emerald-50' : 'text-red-700 bg-red-50'
      } border rounded-md p-2">${msg}</div>`;
    };
    window.addEventListener('error', (e) => say(`‚ö†Ô∏è Error JS: ${e.message}`));

    // ===== Config =====
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh4OOFKU2Z9YU3nTYLeSngPXFAPqADgO_HeT1JVYlLwmPpCnV0aZE-XAlVTEqytac4rOkjX34hD5Rw/pub?output=csv';
    let rows = [];

    // ===== Utils =====
    const clean = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const fmt = (d) => new Date(d).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});
    const monthKey = (d) => new Date(d).toLocaleDateString('es-AR',{month:'long',year:'numeric'});
    const parseCSV = (text) => {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(",").map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
        const o = {};
        headers.forEach((h,i) => o[h] = (cols[i]||'').replace(/^"|"$/g,'').trim());
        return o;
      });
    };

    // ===== Data =====
    async function loadData(url){
      try{
        const res = await fetch(url, { cache: 'no-cache' });
        if(!res.ok) throw new Error(`No se pudo cargar CSV (${res.status})`);
        const txt = await res.text();
        const raw = parseCSV(txt);
        rows = raw.map(r => ({
          fecha: r['Fecha'],
          dia: (r['D√≠a'] || r['D√≠a de la semana'] || ''),
          crovara: r['Crovara (S√°bado)'] || '',
          canning: r['Canning (S√°bado)'] || '',
          libre: r['Libre (S√°bado)'] || '',
          reduccion: r['Reducci√≥n 8-14'] || ''
        }));
        say(`‚úÖ CSV cargado: ${rows.length} filas`, true);
        renderAll();
      }catch(e){
        say(`‚ö†Ô∏è No se pudo cargar tu CSV (${e.message}). Verific√° que el link termine en /pub?output=csv`, false);
      }
    }

    // ===== Render =====
    function renderCalendar(){
      const empleado = document.getElementById('empleadoSelect').value;
      const calEl = document.getElementById('calendar');
      calEl.innerHTML = '';

      const mine = rows.filter(r =>
        clean(r.libre).includes(clean(empleado)) ||
        clean(r.crovara).includes(clean(empleado)) ||
        clean(r.canning).includes(clean(empleado)) ||
        clean(r.reduccion).includes(clean(empleado))
      );

      const groups = {};
      mine.forEach(r => { const k = monthKey(r.fecha); (groups[k] ||= []).push(r); });

      Object.entries(groups).forEach(([mes, arr]) => {
        arr.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
        const box = document.createElement('div');
        box.innerHTML = `<div class="border rounded-xl p-3">
          <div class="font-semibold mb-2">${mes}</div>
          ${arr.map(r => `
            <div class="flex items-center justify-between py-1 border-b last:border-b-0">
              <div class="text-sm font-medium">${fmt(r.fecha)} (${r.dia})</div>
              <div class="flex gap-2">
                ${clean(r.libre).includes(clean(empleado)) ? '<span class="badge b-libre">LIBRE</span>' : ''}
                ${clean(r.crovara).includes(clean(empleado)) ? '<span class="badge b-crovara">Crovara</span>' : ''}
                ${clean(r.canning).includes(clean(empleado)) ? '<span class="badge b-canning">Canning</span>' : ''}
                ${clean(r.reduccion).includes(clean(empleado)) ? '<span class="badge b-red">Reducci√≥n 8‚Äì14</span>' : ''}
              </div>
            </div>
          `).join('')}
        </div>`;
        calEl.appendChild(box);
      });
    }

    function nextEvent(kind){
      const empleado = document.getElementById('empleadoSelect').value;
      const today = new Date();
      const future = rows.filter(r => new Date(r.fecha) >= new Date(today.toDateString()));
      let match;
      if(kind==='libre') match = future.find(r => clean(r.libre).includes(clean(empleado)));
      if(kind==='canning') match = future.find(r => clean(r.canning).includes(clean(empleado)));
      if(kind==='reduccion') match = future.find(r => clean(r.reduccion).includes(clean(empleado)));
      const box = document.getElementById('quickResult');
      if(match){
        const label = kind==='libre' ? 'S√°bado libre' : kind==='canning' ? 'S√°bado en Canning' : 'Jornada reducida';
        box.innerHTML = `<span class="font-medium">${label}:</span> ${fmt(match.fecha)} <span class="text-slate-500">(${match.dia})</span>`;
      } else { box.textContent = 'Sin eventos pr√≥ximos encontrados.'; }
    }

    function checkSwap(){
      const d = document.getElementById('swapDate').value;
      const yo = document.getElementById('swapRequester').value;
      const r = rows.find(x => x.fecha === d);
      const info = document.getElementById('swapInfo');
      const cta  = document.getElementById('swapCTA');
      info.innerHTML = ''; cta.innerHTML = '';
      if(!r){ info.textContent = 'No hay registros para esa fecha.'; return; }
      const asign = [];
      if(r.crovara) asign.push({rol:'Crovara', quien:r.crovara});
      if(r.canning) asign.push({rol:'Canning', quien:r.canning});
      if(r.libre)   asign.push({rol:'Libre',   quien:r.libre});
      if(r.reduccion) asign.push({rol:'Reducci√≥n 8‚Äì14', quien:r.reduccion});
      info.innerHTML = `<div class="p-3 rounded-lg bg-slate-50 border">${asign.map(a=>`‚Ä¢ <b>${a.rol}</b>: ${a.quien}`).join('<br>')}</div>`;
      const subject = encodeURIComponent(`Solicitud de intercambio ‚Äì ${d}`);
      const body = encodeURIComponent(`Hola,%0D%0A%0D%0AQuisiera solicitar intercambio para el d√≠a ${d}.%0D%0AMi nombre: ${yo}.%0D%0AAsignaciones:%0D%0A${asign.map(a=>`- ${a.rol}: ${a.quien}`).join('%0D%0A')}%0D%0APropuesta: ...`);
      cta.innerHTML = `<a href="mailto:?subject=${subject}&body=${body}" class="inline-flex mt-3 px-4 py-2 rounded-md bg-blue-600 text-white">Solicitar cambio</a>`;
    }

    function renderAll(){ renderCalendar(); const box = document.getElementById('quickResult'); if(box) box.textContent=''; }

    // Listeners
    document.getElementById('btnReload').addEventListener('click', renderAll);
    document.getElementById('empleadoSelect').addEventListener('change', renderAll);
    document.querySelectorAll('.qbtn').forEach(b => b.addEventListener('click', () => nextEvent(b.dataset.q)));
    document.getElementById('btnCheckDay').addEventListener('click', checkSwap);

    // Cargar datos al abrir
    loadData(CSV_URL);
  </script>
</body>
</html>
